"use strict";var passport=require("passport"),mongoose=require("mongoose"),Vacante=mongoose.model("Vacante"),Usuarios=mongoose.model("Usuarios"),crypto=require("crypto"),enviarEmail=require("../handlers/email");exports.autenticarUsuarios=passport.authenticate("local",{successRedirect:"/administracion",failureRedirect:"/iniciar-sesion",failureFlash:!0,badRequestMessage:"Ambos campos son obligatorios"}),exports.verificarUsuario=function(e,r,a){if(e.isAuthenticated())return a();r.redirect("/iniciar-sesion")},exports.mostrarPanel=function(r,a){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Vacante.find({autor:r.user._id}));case 2:n=e.sent,a.render("administracion",{nombrePagina:"Panel de administración",tagline:"Crea y Administra las vacantes desde aquí",cerrarSesion:!0,nombre:r.user.nombre,imagen:r.user.imagen,vacantes:n});case 4:case"end":return e.stop()}})},exports.cerrarSesion=function(e,r){return e.logout(),e.flash("correcto","Cerraste Sesión"),r.redirect("/iniciar-sesion")},exports.formReestablecerPassword=function(e,r){r.render("reestablecer-password",{nombrePagina:"Reestablecer tu Password",tagline:"Si ya tienes una cuenta pero olvidaste tu password, coloca tu email"})},exports.enviarToken=function(r,a){var n,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Usuarios.findOne({email:r.body.email}));case 2:return(n=e.sent)||(r.flash("error","No existe esa cuenta"),a.redirect("/iniciar-sesion")),n.token=crypto.randomBytes(20).toString("hex"),n.expira=Date.now()+36e5,e.next=8,regeneratorRuntime.awrap(n.save());case 8:return t="http://".concat(r.headers.host,"/reestablecer-password/").concat(n.token),e.next=11,regeneratorRuntime.awrap(enviarEmail.enviar({usuario:n,subject:"Password reset",resetUrl:t,archivo:"reset"}));case 11:r.flash("correcto","Revisa tu email para las indicaciones"),a.redirect("/iniciar-sesion");case 13:case"end":return e.stop()}})},exports.reestablecerPassword=function(r,a){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Usuarios.findOne({token:r.params.token,expira:{$gt:Date.now()}}));case 2:if(e.sent){e.next=6;break}return r.flash("error","El formulario ya no es valido, intenta de nuevo"),e.abrupt("return",a.redirect("/reestablecer-password"));case 6:a.render("nuevo-password",{nombrePagina:"Nuevo Password"});case 7:case"end":return e.stop()}})},exports.nuevoPassword=function(r,a){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Usuarios.findOne({token:r.params.token,expira:{$gt:Date.now()}}));case 2:if(n=e.sent){e.next=6;break}return r.flash("error","El formulario ya no es valido, intenta de nuevo"),e.abrupt("return",a.redirect("/reestablecer-password"));case 6:return n.password=r.body.password,n.token=void 0,n.expira=void 0,e.next=11,regeneratorRuntime.awrap(n.save());case 11:r.flash("correcto","Password Modificado Correctamente"),a.redirect("/iniciar-sesion");case 13:case"end":return e.stop()}})};