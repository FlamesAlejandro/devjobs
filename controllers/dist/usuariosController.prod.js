"use strict";var mongoose=require("mongoose"),Usuarios=mongoose.model("Usuarios"),multer=require("multer"),shortid=require("shortid");exports.formCrearCuenta=function(e,r){r.render("crear-cuenta",{nombrePagina:"Crea tu cuenta",tagline:"Comienza a publicar tus vacantes gratis, solo debes crear una cuenta"})},exports.validarRegistro=function(e,r,a){e.sanitizeBody("nombre").escape(),e.sanitizeBody("email").escape(),e.sanitizeBody("password").escape(),e.sanitizeBody("confirmar").escape(),e.checkBody("nombre","El nombre es obligatorio").notEmpty(),e.checkBody("email","El email debe ser valido").notEmpty(),e.checkBody("password","El password es obligatorio").notEmpty(),e.checkBody("confirmar","Confirmar es obligatorio").notEmpty(),e.checkBody("confirmar","El password es diferente").equals(e.body.password);var o=e.validationErrors();if(o)return e.flash("error",o.map(function(e){return e.msg})),void r.render("crear-cuenta",{nombrePagina:"Crea tu cuenta",tagline:"Comienza a publicar tus vacantes gratis, solo debes crear una cuenta",mensajes:e.flash()});a()},exports.crearUsuario=function(r,a){var o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return o=new Usuarios(r.body),e.prev=1,e.next=4,regeneratorRuntime.awrap(o.save());case 4:a.redirect("/iniciar-sesion"),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),r.flash("error",error),a.redirect("/crear-cuenta");case 11:case"end":return e.stop()}},null,null,[[1,7]])},exports.formIniciarSesion=function(e,r){r.render("iniciar-sesion",{nombrePagina:"Iniciar Sesión"})},exports.formEditarPerfil=function(e,r){r.render("editar-perfil",{nombrePagina:"Edita tu perfil",cerrarSesion:!0,nombre:e.user.nombre,usuario:e.user,imagen:e.user.imagen})},exports.editarPerfil=function(r,a){var o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Usuarios.findById(r.user._id));case 2:return(o=e.sent).nombre=r.body.nombre,o.email=r.body.email,r.body.password&&(o.password=r.body.password),r.file&&(o.imagen=r.file.filename),e.next=9,regeneratorRuntime.awrap(o.save());case 9:r.flash("correcto","Cambios Guardados Correctamente"),a.redirect("/administracion");case 11:case"end":return e.stop()}})},exports.validarPerfil=function(e,r,a){e.sanitizeBody("nombre").escape(),e.sanitizeBody("email").escape(),e.body.password&&e.sanitizeBody("password").escape(),e.checkBody("nombre","El nombre no puede ir vacio").notEmpty(),e.checkBody("email","El correo no puede ir vacio").notEmpty();var o=e.validationErrors();o&&(e.flash("error",o.map(function(e){return e.msg})),r.render("editar-perfil",{nombrePagina:"Edita tu perfil",cerrarSesion:!0,nombre:e.user.nombre,usuario:e.user,mensajes:e.flash()})),a()},exports.subirImagen=function(r,a,o){upload(r,a,function(e){return e?(e instanceof multer.MulterError&&"LIMIT_FIILE_SIZE"===e.code?r.flash("error","El archivo es muy grande: Máximo 100kb"):r.flash("error",e.message),void a.redirect("/administracion")):o()})};var configuracionMulter={limits:{fileSize:1e5},storage:fileStorage=multer.diskStorage({destination:function(e,r,a){a(null,__dirname+"../../public/uploads/perfiles")},filename:function(e,r,a){var o=r.mimetype.split("/")[1];a(null,"".concat(shortid.generate(),".").concat(o))}}),fileFilter:function(e,r,a){"image/jpeg"===r.mimetype||"image/png"===r.mimetype?a(null,!0):a(new Error("Formato no valido"),!1)}},upload=multer(configuracionMulter).single("imagen");